rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Reglas para la colección 'users'
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer los perfiles de otros (para ver nombres en el foro, etc.).
      allow read: if request.auth != null;
      
      // Un usuario solo puede escribir en su propio documento.
      // Un administrador puede escribir en el documento de cualquier usuario.
      allow write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Reglas para la colección de categorías del foro
    match /forum_categories/{categoryId} {
      // Cualquiera puede leer la lista de categorías.
      allow read: if request.auth != null;
      // Solo un administrador puede crear o eliminar categorías directamente.
      allow create, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Reglas para la colección de sugerencias de categorías
    match /category_suggestions/{suggestionId} {
      // Solo un administrador puede leer y actualizar las sugerencias.
      allow read, update: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      // Cualquier usuario puede crear una sugerencia para sí mismo.
      allow create: if request.auth != null && request.resource.data.requestedBy == request.auth.uid;
    }
    
    // Reglas para los mensajes del foro
    match /forum_messages/{messageId} {
      // Cualquiera puede leer mensajes. La app filtra qué foros mostrar.
      allow read: if request.auth != null;
      // Solo los miembros de una comunidad pueden escribir en ella.
      allow create: if request.auth != null 
                      && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.followedCategoryIds.has(request.resource.data.categoryId);
      // No se permite actualizar o eliminar mensajes.
      allow update, delete: if false;
    }
  }
}
