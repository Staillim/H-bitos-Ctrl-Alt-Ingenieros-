rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Los usuarios pueden leer cualquier perfil (necesario para nombres en el foro, etc.), 
    // pero solo pueden escribir en su propio documento. Los administradores pueden escribir en cualquier perfil.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Las categorías del foro pueden ser leídas por cualquier usuario autenticado.
    // Solo un administrador puede crear, actualizar o eliminar categorías directamente.
    match /forum_categories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Los usuarios autenticados pueden crear sugerencias de categorías.
    // Solo un administrador puede leerlas, actualizarlas o eliminarlas.
    match /category_suggestions/{suggestionId} {
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow create: if request.auth != null && request.resource.data.requestedBy == request.auth.uid;
    }
    
    // Los mensajes del foro pueden ser leídos por cualquier usuario autenticado.
    // Solo los usuarios que siguen una comunidad (sean 'user' o 'admin') pueden escribir en ella.
    match /forum_messages/{messageId} {
      function isMember(categoryId) {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.followedCategoryIds.has(categoryId);
      }

      allow read: if request.auth != null;
      allow create: if isMember(request.resource.data.categoryId);

      // No se permite actualizar o eliminar mensajes.
      allow update, delete: if false;
    }
  }
}
